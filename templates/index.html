<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LSP2025 Drawer - WebUI</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            padding: 10px;
        }
        
        .container {
            max-width: 1920px;
            margin: 0 auto;
            background-color: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        h1 {
            font-size: 24px;
            margin-bottom: 15px;
            color: #333;
        }
        
        .section {
            margin-bottom: 20px;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #555;
        }
        
        /* ç”»æ¿é¢„è§ˆåŒºåŸŸ */
        #board-canvas-container {
            width: 100%;
            height: 600px;
            overflow: hidden;
            background-color: #222;
            border: 2px solid #333;
            position: relative;
            cursor: grab;
        }
        
        #board-canvas-container:active {
            cursor: grabbing;
        }
        
        #board-canvas {
            display: block;
            image-rendering: pixelated;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .controls {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        button:active {
            background-color: #3d8b40;
        }
        
        .btn-secondary {
            background-color: #008CBA;
        }
        
        .btn-secondary:hover {
            background-color: #007399;
        }
        
        .btn-danger {
            background-color: #f44336;
        }
        
        .btn-danger:hover {
            background-color: #da190b;
        }
        
        /* è¿›åº¦æ¡ */
        .progress-container {
            margin: 10px 0;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background-color: #ddd;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #4CAF50;
            transition: width 0.3s ease, background-color 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .progress-fill.danger {
            background-color: #d32f2f;
        }
        
        .info-text {
            margin: 5px 0;
            font-size: 14px;
            color: #333;
        }
        
        /* å›¾ç‰‡ç®¡ç†è¡¨æ ¼ */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        th {
            background-color: #4CAF50;
            color: white;
        }
        
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        tr:hover {
            background-color: #ddd;
        }
        
        .enabled-check {
            color: green;
            font-weight: bold;
        }
        
        .disabled-cross {
            color: red;
            font-weight: bold;
        }
        
        /* æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 5px;
            width: 80%;
            max-width: 500px;
        }
        
        .modal-header {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .zoom-info {
            font-size: 14px;
            color: #666;
            margin-left: 10px;
        }
        
        .connection-status {
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 14px;
            display: inline-block;
        }
        
        .status-connected {
            background-color: #4CAF50;
            color: white;
        }
        
        .status-disconnected {
            background-color: #f44336;
            color: white;
        }
        
        .status-connecting {
            background-color: #FF9800;
            color: white;
        }
        
        /* æ‹–åŠ¨è®¾ç½®èµ·ç‚¹æ¨¡æ€æ¡† */
        #drag-position-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
        }
        
        #drag-position-modal .modal-content {
            background-color: #333;
            margin: 20px auto;
            padding: 0;
            width: 95%;
            max-width: 1200px;
            height: 90%;
            display: flex;
            flex-direction: column;
        }
        
        #drag-position-canvas-container {
            flex: 1;
            background-color: #222;
            position: relative;
            overflow: hidden;
            cursor: default;
        }
        
        #drag-position-canvas {
            position: absolute;
            top: 0;
            left: 0;
            image-rendering: pixelated;
        }
        
        .drag-position-header {
            padding: 15px;
            background-color: #444;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .drag-position-footer {
            padding: 15px;
            background-color: #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .position-info {
            color: white;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>LSP2025 Drawer - WebUI</h1>
        
        <!-- ç”»æ¿é¢„è§ˆåŒºåŸŸ -->
        <div class="section">
            <div class="section-title">ç”»æ¿é¢„è§ˆ</div>
            <div id="board-canvas-container">
                <canvas id="board-canvas" width="1000" height="600"></canvas>
            </div>
            <div class="controls">
                <button id="toggle-overlay">ğŸ‘ï¸ é¢„è§ˆæˆæœ</button>
                <button id="drag-set-position" class="btn-secondary">ğŸ¯ æ‹–åŠ¨è®¾ç½®èµ·ç‚¹</button>
                <span class="zoom-info">ç¼©æ”¾: <span id="zoom-level">100</span>% | æ‹–æ‹½å¹³ç§» | æ»šè½®ç¼©æ”¾</span>
            </div>
        </div>
        
        <!-- è¿›åº¦ä¿¡æ¯ -->
        <div class="section">
            <div class="section-title">ç»˜åˆ¶è¿›åº¦</div>
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill">0.00%</div>
                </div>
            </div>
            <div class="info-text" id="info-text">ç­‰å¾…æ•°æ®...</div>
            <div class="info-text" id="users-info">å¯ç”¨: 0 | å°±ç»ª: 0</div>
            <div class="info-text" id="eta-info"></div>
            <div class="info-text">
                è¿æ¥çŠ¶æ€: <span class="connection-status status-connecting" id="conn-status">è¿æ¥ä¸­...</span>
            </div>
            <div class="info-text">
                åç«¯çŠ¶æ€: <span class="connection-status" id="backend-status">æœªçŸ¥</span>
                <button id="restart-backend" class="btn-danger" style="margin-left:10px;">ğŸ” é‡å¯åç«¯</button>
            </div>
        </div>
        
        <!-- å›¾ç‰‡ç®¡ç† -->
        <div class="section">
            <div class="section-title">å›¾ç‰‡ç®¡ç†</div>
            <table id="images-table">
                <thead>
                    <tr>
                        <th>å¯ç”¨</th>
                        <th>å›¾ç‰‡åç§°</th>
                        <th>èµ·ç‚¹X</th>
                        <th>èµ·ç‚¹Y</th>
                        <th>å®½åº¦</th>
                        <th>é«˜åº¦</th>
                        <th>æ¨¡å¼</th>
                        <th>æƒé‡</th>
                        <th>æ´¾å‘</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="images-tbody">
                    <tr><td colspan="10">åŠ è½½ä¸­...</td></tr>
                </tbody>
            </table>
            <div class="controls">
                <button id="refresh-images">ğŸ”„ åˆ·æ–°å›¾ç‰‡</button>
                <button id="add-image-btn" class="btn-secondary">â• ä¸Šä¼ å›¾ç‰‡</button>
                <button id="add-attack-btn" class="btn-secondary">âš”ï¸ æ·»åŠ æ”»å‡»</button>
            </div>
        </div>
        
        <!-- ç”¨æˆ·ç®¡ç† -->
        <div class="section">
            <div class="section-title">ç”¨æˆ·ç®¡ç†</div>
            <table id="users-table">
                <thead>
                    <tr>
                        <th>UID</th>
                        <th>Access Key</th>
                        <th>TokençŠ¶æ€</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="users-tbody">
                    <tr><td colspan="4">åŠ è½½ä¸­...</td></tr>
                </tbody>
            </table>
            <div id="users-pagination" style="margin-top:8px; display:flex; gap:8px; align-items:center;">
                <button id="users-prev" class="btn-secondary">ä¸Šä¸€é¡µ</button>
                <span>ç¬¬ <span id="users-page">1</span> é¡µ / å…± <span id="users-total-pages">1</span> é¡µ</span>
                <button id="users-next" class="btn-secondary">ä¸‹ä¸€é¡µ</button>
            </div>
            <div class="controls">
                <button id="refresh-users">ğŸ”„ åˆ·æ–°ç”¨æˆ·</button>
                <button id="add-user-btn" class="btn-secondary">â• æ·»åŠ ç”¨æˆ·</button>
            </div>
        </div>
    </div>
    
    <!-- ç¼–è¾‘å›¾ç‰‡æ¨¡æ€æ¡† -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">ç¼–è¾‘å›¾ç‰‡</div>
            <div class="form-group">
                <label>èµ·ç‚¹ X:</label>
                <input type="number" id="edit-x" min="0" max="999">
            </div>
            <div class="form-group">
                <label>èµ·ç‚¹ Y:</label>
                <input type="number" id="edit-y" min="0" max="599">
            </div>
            <div class="form-group">
                <label>ç»˜å›¾æ¨¡å¼:</label>
                <select id="edit-mode">
                    <option value="horizontal">horizontal</option>
                    <option value="concentric">concentric</option>
                    <option value="random">random</option>
                </select>
            </div>
            <div class="form-group">
                <label>æƒé‡:</label>
                <input type="number" id="edit-weight" min="0.1" max="10" step="0.1">
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="edit-enabled"> å¯ç”¨
                </label>
            </div>
            <div class="controls">
                <button id="save-edit">ä¿å­˜</button>
                <button id="cancel-edit" class="btn-secondary">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    
    <!-- æ‹–åŠ¨è®¾ç½®èµ·ç‚¹æ¨¡æ€æ¡† -->
    <div id="drag-position-modal">
        <div class="modal-content">
            <div class="drag-position-header">
                <div>
                    <span id="drag-position-title">æ‹–åŠ¨è®¾ç½®èµ·ç‚¹</span>
                </div>
                <div>
                    <button id="close-drag-position" class="btn-danger">å…³é—­</button>
                </div>
            </div>
            <div id="drag-position-canvas-container">
                <canvas id="drag-position-canvas" width="1000" height="600"></canvas>
            </div>
            <div class="drag-position-footer">
                <div class="position-info">
                    ä½ç½®: <span id="drag-position-coords">(0, 0)</span>
                </div>
                <div class="controls">
                    <button id="apply-drag-position">âœ“ åº”ç”¨</button>
                    <button id="cancel-drag-position" class="btn-secondary">âœ— å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æ·»åŠ ç”¨æˆ·æ¨¡æ€æ¡† -->
    <div id="add-user-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">æ·»åŠ ç”¨æˆ·</div>
            <div class="form-group">
                <label>UID:</label>
                <input type="number" id="add-user-uid" placeholder="è¾“å…¥ç”¨æˆ·UID">
            </div>
            <div class="form-group">
                <label>Access Key:</label>
                <input type="text" id="add-user-key" placeholder="è¾“å…¥Access Key">
            </div>
            <div class="controls">
                <button id="save-add-user">ä¿å­˜</button>
                <button id="cancel-add-user" class="btn-secondary">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    
    <!-- ä¸Šä¼ å›¾ç‰‡æ¨¡æ€æ¡† -->
    <div id="upload-image-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">ä¸Šä¼ å›¾ç‰‡</div>
            <div class="form-group">
                <label>é€‰æ‹©å›¾ç‰‡æ–‡ä»¶:</label>
                <input type="file" id="upload-image-file" accept="image/*">
            </div>
            <div class="form-group">
                <label>èµ·ç‚¹ X:</label>
                <input type="number" id="upload-image-x" value="0" min="0" max="999">
            </div>
            <div class="form-group">
                <label>èµ·ç‚¹ Y:</label>
                <input type="number" id="upload-image-y" value="0" min="0" max="599">
            </div>
            <div class="form-group">
                <label>ç»˜å›¾æ¨¡å¼:</label>
                <select id="upload-image-mode">
                    <option value="random">random</option>
                    <option value="horizontal">horizontal</option>
                    <option value="concentric">concentric</option>
                </select>
            </div>
            <div class="form-group">
                <label>æƒé‡:</label>
                <input type="number" id="upload-image-weight" value="1.0" min="0.1" max="10" step="0.1">
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="upload-image-enabled" checked> å¯ç”¨
                </label>
            </div>
            <div class="controls">
                <button id="save-upload-image">ä¸Šä¼ å¹¶æ·»åŠ </button>
                <button id="cancel-upload-image" class="btn-secondary">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    
    <!-- æ·»åŠ æ”»å‡»æ¨¡æ€æ¡† -->
    <div id="add-attack-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">æ·»åŠ æ”»å‡»</div>
            <div class="form-group">
                <label>æ”»å‡»ç±»å‹:</label>
                <select id="attack-kind">
                    <option value="white">ç™½ç‚¹</option>
                    <option value="green">äº®ç»¿è‰²ç‚¹</option>
                    <option value="random">éšæœºè‰²ç‚¹</option>
                </select>
            </div>
            <div class="form-group">
                <label>å®½åº¦:</label>
                <input type="number" id="attack-width" value="100" min="1" max="1000">
            </div>
            <div class="form-group">
                <label>é«˜åº¦:</label>
                <input type="number" id="attack-height" value="100" min="1" max="600">
            </div>
            <div class="form-group">
                <label>ç‚¹æ•°é‡ (å¯é€‰ï¼Œé»˜è®¤ä¸ºé¢ç§¯çš„2%):</label>
                <input type="number" id="attack-dot-count" placeholder="ç•™ç©ºä½¿ç”¨é»˜è®¤å€¼" min="1">
            </div>
            <div class="form-group">
                <label>èµ·ç‚¹ X:</label>
                <input type="number" id="attack-x" value="0" min="0" max="999">
            </div>
            <div class="form-group">
                <label>èµ·ç‚¹ Y:</label>
                <input type="number" id="attack-y" value="0" min="0" max="599">
            </div>
            <div class="form-group">
                <label>ç»˜å›¾æ¨¡å¼:</label>
                <select id="attack-mode">
                    <option value="random">random</option>
                    <option value="horizontal">horizontal</option>
                    <option value="concentric">concentric</option>
                </select>
            </div>
            <div class="form-group">
                <label>æƒé‡:</label>
                <input type="number" id="attack-weight" value="1.0" min="0.1" max="10" step="0.1">
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="attack-enabled" checked> å¯ç”¨
                </label>
            </div>
            <div class="controls">
                <button id="save-add-attack">æ·»åŠ æ”»å‡»</button>
                <button id="cancel-add-attack" class="btn-secondary">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    
    <script>
        // WebSocket è¿æ¥
        const socket = io();

        // å…¨å±€çŠ¶æ€
        let currentScale = 1.0;
        let offsetX = 0;
        let offsetY = 0;
        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;
    let overlayEnabled = false;
        let editingIndex = null;
        // ç”¨æˆ·åˆ—è¡¨åˆ†é¡µ
        let usersPage = 1;
        const usersPageSize = 10;

        // æ‹–åŠ¨è®¾ç½®èµ·ç‚¹ç›¸å…³ï¼ˆä½¿ç”¨ç¼“å­˜é¿å…é¢‘ç¹ fetchï¼‰
        let dragPositionIndex = null;
        let dragPositionImgX = 0;
        let dragPositionImgY = 0;
        let dragPositionImgWidth = 0;
        let dragPositionImgHeight = 0;
        let dragPositionDragging = false;
        let dragPositionStartMouseX = 0;
        let dragPositionStartMouseY = 0;
        let dragPositionStartImgX = 0;
        let dragPositionStartImgY = 0;
        let dragBaseBitmap = null;
        let dragTargetBitmap = null;

        // å†å²æ•°æ®ç”¨äºè®¡ç®—å¢é•¿ç‡
        const progressHistory = [];
        const WINDOW_SECONDS = 60;

        // Canvas å…ƒç´ 
        const canvas = document.getElementById('board-canvas');
        const ctx = canvas.getContext('2d');
        const container = document.getElementById('board-canvas-container');

        // æ¸²æŸ“/ç¼“å­˜ä¼˜åŒ–
        let pendingRedraw = false; // æ ‡è®°ä¸‹ä¸€å¸§éœ€è¦ redraw
        let lastBoardImageSrc = null;
        let cachedBoardBitmap = null;

        // åˆå§‹åŒ–ç”»å¸ƒï¼ˆå†…éƒ¨åƒç´  1000x600ï¼‰ï¼Œä½¿ç”¨ CSS transform åšç¼©æ”¾/å¹³ç§»
        function initCanvas() {
            canvas.width = 1000;
            canvas.height = 600;
            canvas.style.transformOrigin = '0 0';
            setCanvasTransform();
            scheduleRedraw();
        }

        function scheduleRedraw() {
            if (pendingRedraw) return;
            pendingRedraw = true;
            requestAnimationFrame(() => {
                pendingRedraw = false;
                redrawCanvas();
            });
        }

        async function redrawCanvas() {
            try {
                const res = await fetch('/api/board');
                const data = await res.json();
                if (!data || !data.image) return;

                const src = data.image;
                if (src !== lastBoardImageSrc) {
                    lastBoardImageSrc = src;
                    try { if (cachedBoardBitmap && cachedBoardBitmap.close) cachedBoardBitmap.close(); } catch (e) {}
                    // ä½¿ç”¨ blob -> createImageBitmap æ¥æå‡æ€§èƒ½
                    const blob = await (await fetch('data:image/png;base64,' + src)).blob();
                    try {
                        cachedBoardBitmap = await createImageBitmap(blob);
                    } catch (e) {
                        // fallback: decode via Image
                        const img = new Image();
                        await new Promise((resolve) => { img.onload = resolve; img.onerror = resolve; img.src = 'data:image/png;base64,' + src; });
                        ctx.clearRect(0,0,canvas.width,canvas.height);
                        ctx.drawImage(img,0,0);
                        return;
                    }
                }

                ctx.clearRect(0,0,canvas.width,canvas.height);
                if (cachedBoardBitmap) ctx.drawImage(cachedBoardBitmap, 0, 0, canvas.width, canvas.height);
            } catch (err) {
                console.error('è·å–ç”»æ¿å¤±è´¥:', err);
            }
        }

        // heatmap removed on frontend

        // åº”ç”¨ CSS transformï¼ˆç»Ÿä¸€ç®¡ç†ï¼‰
        function setCanvasTransform() {
            canvas.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${currentScale})`;
        }

        // ç”»å¸ƒæ‹–æ‹½ï¼ˆä½¿ç”¨ container æ•è·äº‹ä»¶ï¼Œæ›´æ–° CSS transformï¼‰
        container.addEventListener('mousedown', e => {
            isDragging = true;
            dragStartX = e.clientX;
            dragStartY = e.clientY;
            container.style.cursor = 'grabbing';
        });

        container.addEventListener('mousemove', e => {
            if (!isDragging) return;
            const dx = e.clientX - dragStartX;
            const dy = e.clientY - dragStartY;
            offsetX += dx;
            offsetY += dy;

            const canvasDisplayWidth = 1000 * currentScale;
            const canvasDisplayHeight = 600 * currentScale;
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;
            const minOffsetX = -canvasDisplayWidth + 100;
            const minOffsetY = -canvasDisplayHeight + 100;
            const maxOffsetX = containerWidth - 100;
            const maxOffsetY = containerHeight - 100;
            offsetX = Math.max(minOffsetX, Math.min(maxOffsetX, offsetX));
            offsetY = Math.max(minOffsetY, Math.min(maxOffsetY, offsetY));

            setCanvasTransform();
            dragStartX = e.clientX;
            dragStartY = e.clientY;
        });

        container.addEventListener('mouseup', () => { isDragging = false; container.style.cursor = 'grab'; });
        container.addEventListener('mouseleave', () => { isDragging = false; container.style.cursor = 'grab'; });

        // æ»šè½®ç¼©æ”¾ï¼ˆä¿ç•™é¼ æ ‡ç„¦ç‚¹ï¼‰
        container.addEventListener('wheel', e => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            const oldScale = currentScale;
            currentScale = Math.max(0.1, Math.min(5.0, currentScale * delta));
            const rect = container.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            offsetX = mouseX - (mouseX - offsetX) * (currentScale / oldScale);
            offsetY = mouseY - (mouseY - offsetY) * (currentScale / oldScale);
            setCanvasTransform();
            document.getElementById('zoom-level').textContent = Math.round(currentScale * 100);
            scheduleRedraw();
        });

        // åˆ‡æ¢é¢„è§ˆ
        document.getElementById('toggle-overlay').addEventListener('click', () => {
            fetch('/api/overlay/toggle', { method: 'POST' })
                .then(res => res.json())
                .then(data => { overlayEnabled = data.overlay; scheduleRedraw(); })
                .catch(err => console.error('åˆ‡æ¢é¢„è§ˆå¤±è´¥:', err));
        });

        // heatmap control removed

        // æ›´æ–°çŠ¶æ€ä¿¡æ¯
        function updateStatus() {
            fetch('/api/status')
                .then(res => res.json())
                .then(data => {
                    const total = data.total || 0;
                    const mismatched = data.mismatched || 0;
                    const completed = Math.max(0, total - mismatched);
                    const pct = total > 0 ? (completed / total * 100) : 100;
                    const fill = document.getElementById('progress-fill');
                    fill.style.width = pct + '%';
                    fill.textContent = pct.toFixed(2) + '%';
                    const now = Date.now() / 1000;
                    progressHistory.push({ time: now, pct: pct });
                    while (progressHistory.length > 0 && (now - progressHistory[0].time > WINDOW_SECONDS)) progressHistory.shift();
                    let growthStr = 'å¢é•¿: --';
                    let etaStr = '';
                    let isDanger = false;
                    if (progressHistory.length >= 2) {
                        const first = progressHistory[0];
                        const last = progressHistory[progressHistory.length - 1];
                        const dt = Math.max(0.000001, last.time - first.time);
                        const growth = (last.pct - first.pct) / dt;
                        growthStr = `å¢é•¿: ${growth >= 0 ? '+' : ''}${growth.toFixed(2)}%/s`;
                        if (growth > 0.000001) {
                            const remainPct = Math.max(0, 100 - pct);
                            const etaSec = remainPct / growth;
                            if (etaSec >= 3600) { const h = Math.floor(etaSec / 3600); const m = Math.floor((etaSec % 3600) / 60); etaStr = `ä¼°è®¡å‰©ä½™: ${h}h${m}m`; }
                            else if (etaSec >= 60) { const m = Math.floor(etaSec / 60); const s = Math.floor(etaSec % 60); etaStr = `ä¼°è®¡å‰©ä½™: ${m}m${s}s`; }
                            else { etaStr = `ä¼°è®¡å‰©ä½™: ${Math.floor(etaSec)}s`; }
                        } else if (pct < 95) { isDanger = true; etaStr = 'ä¼°è®¡å‰©ä½™: æˆ‘ä»¬æ­£åœ¨è¢«æ”»å‡»ï¼Œæ— æ³•æŠµæŠ—'; fill.classList.add('danger'); }
                        else { etaStr = 'ä¼°è®¡å‰©ä½™: å³å°†å®Œæˆ'; }
                        if (!isDanger && growth >= 0) fill.classList.remove('danger');
                    }
                    const resistStr = data.resistance_pct != null ? `æŠµæŠ—ç‡: ${data.resistance_pct.toFixed(1)}%` : 'æŠµæŠ—ç‡: --';
                    document.getElementById('info-text').textContent = `è¿›åº¦: ${pct.toFixed(2)}% | æ€»: ${total} | æœªè¾¾æ ‡: ${mismatched} | ${resistStr} | ${growthStr}`;
                    document.getElementById('users-info').textContent = `å¯ç”¨: ${data.available || 0} | å°±ç»ª: ${data.ready_count || 0}`;
                    document.getElementById('eta-info').textContent = etaStr;
                    const connStatus = document.getElementById('conn-status');
                    if (data.conn_status === 'connected') {
                        const duration = Math.floor(Date.now() / 1000 - (data.conn_since || 0));
                        const h = Math.floor(duration / 3600); const m = Math.floor((duration % 3600) / 60); const s = duration % 60;
                        connStatus.textContent = `å·²è¿æ¥ ${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
                        connStatus.className = 'connection-status status-connected';
                    } else if (data.conn_status === 'connecting') { connStatus.textContent = 'è¿æ¥ä¸­...'; connStatus.className = 'connection-status status-connecting'; }
                    else { connStatus.textContent = `æ–­å¼€ [${data.conn_reason || 'æœªçŸ¥åŸå› '}]`; connStatus.className = 'connection-status status-disconnected'; }
                    if (data.server_offline) connStatus.textContent += 'ï¼ˆæœåŠ¡å™¨ç¦»çº¿ï¼‰';

                    // åç«¯è¿è¡ŒçŠ¶æ€æ˜¾ç¤º
                    try {
                        const backendEl = document.getElementById('backend-status');
                        const bs = data.backend_status || 'unknown';
                        if (bs === 'online') {
                            backendEl.textContent = 'åœ¨çº¿';
                            backendEl.className = 'connection-status status-connected';
                        } else if (bs === 'restarting') {
                            backendEl.textContent = 'é‡å¯ä¸­';
                            backendEl.className = 'connection-status status-connecting';
                        } else if (bs === 'exception') {
                            let msg = data.backend_exception || '';
                            backendEl.textContent = 'å¼‚å¸¸' + (msg ? (': ' + msg.split('\n')[0]) : '');
                            backendEl.className = 'connection-status status-disconnected';
                        } else {
                            backendEl.textContent = String(bs);
                            backendEl.className = 'connection-status';
                        }
                    } catch (e) { console.error('æ›´æ–°åç«¯çŠ¶æ€å¤±è´¥', e); }
                })
                .catch(err => console.error('æ›´æ–°çŠ¶æ€å¤±è´¥:', err));
        }

        // åŠ è½½å›¾ç‰‡åˆ—è¡¨
        function loadImages() {
            fetch('/api/images')
                .then(res => res.json())
                .then(data => {
                    const tbody = document.getElementById('images-tbody');
                    tbody.innerHTML = '';
                    data.images.forEach(img => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${img.enabled ? '<span class="enabled-check">âœ“</span>' : '<span class="disabled-cross">âœ—</span>'}</td>
                            <td>${img.name}</td>
                            <td>${img.start_x}</td>
                            <td>${img.start_y}</td>
                            <td>${img.width}</td>
                            <td>${img.height}</td>
                            <td>${img.draw_mode}</td>
                            <td>${img.weight}</td>
                            <td>${img.assigned}</td>
                            <td>
                                <button onclick="editImage(${img.index})">ç¼–è¾‘</button>
                                <button onclick="toggleImage(${img.index})" class="btn-secondary">åˆ‡æ¢</button>
                                <button onclick="deleteImage(${img.index})" class="btn-danger">åˆ é™¤</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                })
                .catch(err => console.error('åŠ è½½å›¾ç‰‡åˆ—è¡¨å¤±è´¥:', err));
        }

        function toggleImage(index) {
            fetch('/api/images/toggle', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ index: index }) })
                .then(res => res.json()).then(() => { loadImages(); scheduleRedraw(); }).catch(err => console.error('åˆ‡æ¢å›¾ç‰‡å¤±è´¥:', err));
        }

        function editImage(index) {
            fetch('/api/images').then(res => res.json()).then(data => {
                const img = data.images.find(i => i.index === index); if (!img) return;
                editingIndex = index;
                document.getElementById('edit-x').value = img.start_x;
                document.getElementById('edit-y').value = img.start_y;
                document.getElementById('edit-mode').value = img.draw_mode;
                document.getElementById('edit-weight').value = img.weight;
                document.getElementById('edit-enabled').checked = img.enabled;
                document.getElementById('edit-modal').style.display = 'block';
            }).catch(err => console.error('è·å–å›¾ç‰‡ä¿¡æ¯å¤±è´¥:', err));
        }

        document.getElementById('save-edit').addEventListener('click', () => {
            if (editingIndex === null) return;
            const data = { index: editingIndex, start_x: parseInt(document.getElementById('edit-x').value), start_y: parseInt(document.getElementById('edit-y').value), draw_mode: document.getElementById('edit-mode').value, weight: parseFloat(document.getElementById('edit-weight').value), enabled: document.getElementById('edit-enabled').checked };
            fetch('/api/images/edit', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) })
                .then(res => res.json()).then(() => { document.getElementById('edit-modal').style.display = 'none'; loadImages(); scheduleRedraw(); }).catch(err => console.error('ä¿å­˜ç¼–è¾‘å¤±è´¥:', err));
        });

        document.getElementById('cancel-edit').addEventListener('click', () => { document.getElementById('edit-modal').style.display = 'none'; editingIndex = null; });

        function deleteImage(index) { if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå›¾ç‰‡å—?')) return; fetch('/api/images/delete', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ index: index }) }).then(res => res.json()).then(() => { loadImages(); scheduleRedraw(); }).catch(err => console.error('åˆ é™¤å›¾ç‰‡å¤±è´¥:', err)); }

        document.getElementById('refresh-images').addEventListener('click', () => { loadImages(); scheduleRedraw(); });

        // ============= ç”¨æˆ·ç®¡ç†åŠŸèƒ½ =============
        
        function loadUsers() {
            fetch('/api/users')
                .then(res => res.json())
                .then(data => {
                    const tbody = document.getElementById('users-tbody');
                    tbody.innerHTML = '';
                    const users = data.users || [];
                    const total = users.length;
                    const totalPages = Math.max(1, Math.ceil(total / usersPageSize));
                    if (usersPage > totalPages) usersPage = totalPages;
                    const start = (usersPage - 1) * usersPageSize;
                    const end = Math.min(total, start + usersPageSize);
                    for (let i = start; i < end; i++) {
                        const user = users[i];
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${user.uid}</td>
                            <td>${(user.access_key || '').substring(0, 4)}****</td>
                            <td>${user.has_token ? '<span class="enabled-check">âœ“ æœ‰æ•ˆ</span>' : '<span class="disabled-cross">âœ— æ— æ•ˆ</span>'}</td>
                            <td>
                                <button onclick="deleteUser(${user.index})" class="btn-danger">åˆ é™¤</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    }
                    document.getElementById('users-page').textContent = usersPage;
                    document.getElementById('users-total-pages').textContent = totalPages;
                })
                .catch(err => console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', err));
        }

        // åˆ†é¡µæ§åˆ¶
        document.getElementById('users-prev').addEventListener('click', () => {
            if (usersPage > 1) { usersPage--; loadUsers(); }
        });
        document.getElementById('users-next').addEventListener('click', () => {
            usersPage++; loadUsers();
        });

        function deleteUser(index) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç”¨æˆ·å—ï¼Ÿç”¨æˆ·å°†ç«‹å³ä»ç»˜åˆ¶é˜Ÿåˆ—ä¸­ç§»é™¤ã€‚')) return;
            fetch('/api/users/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ index: index })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message || 'åˆ é™¤æˆåŠŸ');
                        loadUsers();
                    } else {
                        alert('åˆ é™¤å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                })
                .catch(err => {
                    console.error('åˆ é™¤ç”¨æˆ·å¤±è´¥:', err);
                    alert('åˆ é™¤å¤±è´¥: ' + err.message);
                });
        }

        document.getElementById('refresh-users').addEventListener('click', loadUsers);
        
        document.getElementById('add-user-btn').addEventListener('click', () => {
            document.getElementById('add-user-modal').style.display = 'block';
            document.getElementById('add-user-uid').value = '';
            document.getElementById('add-user-key').value = '';
        });

        document.getElementById('save-add-user').addEventListener('click', () => {
            const uid = document.getElementById('add-user-uid').value;
            const key = document.getElementById('add-user-key').value;
            
            if (!uid || !key) {
                alert('è¯·å¡«å†™æ‰€æœ‰å­—æ®µ');
                return;
            }
            
            fetch('/api/users/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ uid: parseInt(uid), access_key: key })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message || 'æ·»åŠ æˆåŠŸ');
                        document.getElementById('add-user-modal').style.display = 'none';
                        loadUsers();
                    } else {
                        alert('æ·»åŠ å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                })
                .catch(err => {
                    console.error('æ·»åŠ ç”¨æˆ·å¤±è´¥:', err);
                    alert('æ·»åŠ å¤±è´¥: ' + err.message);
                });
        });

        document.getElementById('cancel-add-user').addEventListener('click', () => {
            document.getElementById('add-user-modal').style.display = 'none';
        });

        // åç«¯é‡å¯æŒ‰é’®
        document.getElementById('restart-backend').addEventListener('click', () => {
            if (!confirm('ç¡®å®šè¦é‡å¯åç«¯å—ï¼Ÿè¿™ä¼šåœæ­¢å½“å‰åå°å¹¶å°è¯•é‡å¯ã€‚')) return;
            fetch('/api/restart', { method: 'POST' })
                .then(res => res.json())
                .then(data => { alert(data.message || 'æ­£åœ¨é‡å¯åç«¯'); })
                .catch(err => { console.error('é‡å¯è¯·æ±‚å¤±è´¥:', err); alert('é‡å¯è¯·æ±‚å¤±è´¥: ' + err.message); });
        });

        // ============= å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½ =============
        
        document.getElementById('add-image-btn').addEventListener('click', () => {
            document.getElementById('upload-image-modal').style.display = 'block';
            document.getElementById('upload-image-file').value = '';
        });

        document.getElementById('save-upload-image').addEventListener('click', async () => {
            const fileInput = document.getElementById('upload-image-file');
            if (!fileInput.files || fileInput.files.length === 0) {
                alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                return;
            }
            
            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                // å…ˆä¸Šä¼ æ–‡ä»¶
                const uploadRes = await fetch('/api/images/upload', {
                    method: 'POST',
                    body: formData
                });
                const uploadData = await uploadRes.json();
                
                if (!uploadData.success) {
                    alert('ä¸Šä¼ å¤±è´¥: ' + (uploadData.error || 'æœªçŸ¥é”™è¯¯'));
                    return;
                }
                
                // ç„¶åæ·»åŠ åˆ°é…ç½®
                const addData = {
                    image_path: uploadData.filepath,
                    start_x: parseInt(document.getElementById('upload-image-x').value),
                    start_y: parseInt(document.getElementById('upload-image-y').value),
                    draw_mode: document.getElementById('upload-image-mode').value,
                    weight: parseFloat(document.getElementById('upload-image-weight').value),
                    enabled: document.getElementById('upload-image-enabled').checked
                };
                
                const addRes = await fetch('/api/images/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(addData)
                });
                const addResData = await addRes.json();
                
                if (addResData.success) {
                    alert(addResData.message || 'æ·»åŠ æˆåŠŸ');
                    document.getElementById('upload-image-modal').style.display = 'none';
                    loadImages();
                    scheduleRedraw();
                } else {
                    alert('æ·»åŠ å¤±è´¥: ' + (addResData.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (err) {
                console.error('ä¸Šä¼ å›¾ç‰‡å¤±è´¥:', err);
                alert('æ“ä½œå¤±è´¥: ' + err.message);
            }
        });

        document.getElementById('cancel-upload-image').addEventListener('click', () => {
            document.getElementById('upload-image-modal').style.display = 'none';
        });

        // ============= æ”»å‡»åŠŸèƒ½ =============
        
        document.getElementById('add-attack-btn').addEventListener('click', () => {
            document.getElementById('add-attack-modal').style.display = 'block';
        });

        document.getElementById('save-add-attack').addEventListener('click', () => {
            const attackData = {
                attack_kind: document.getElementById('attack-kind').value,
                width: parseInt(document.getElementById('attack-width').value),
                height: parseInt(document.getElementById('attack-height').value),
                start_x: parseInt(document.getElementById('attack-x').value),
                start_y: parseInt(document.getElementById('attack-y').value),
                draw_mode: document.getElementById('attack-mode').value,
                weight: parseFloat(document.getElementById('attack-weight').value),
                enabled: document.getElementById('attack-enabled').checked
            };
            
            const dotCount = document.getElementById('attack-dot-count').value;
            if (dotCount) {
                attackData.dot_count = parseInt(dotCount);
            }
            
            fetch('/api/attack/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(attackData)
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message || 'æ·»åŠ æˆåŠŸ');
                        document.getElementById('add-attack-modal').style.display = 'none';
                        loadImages();
                        scheduleRedraw();
                    } else {
                        alert('æ·»åŠ å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                })
                .catch(err => {
                    console.error('æ·»åŠ æ”»å‡»å¤±è´¥:', err);
                    alert('æ“ä½œå¤±è´¥: ' + err.message);
                });
        });

        document.getElementById('cancel-add-attack').addEventListener('click', () => {
            document.getElementById('add-attack-modal').style.display = 'none';
        });

        // ============= æ‹–åŠ¨è®¾ç½®èµ·ç‚¹åŠŸèƒ½ =============

        // æ‹–åŠ¨è®¾ç½®èµ·ç‚¹åŠŸèƒ½ï¼šæ‰“å¼€æ—¶ç¼“å­˜åº•å›¾å’Œç›®æ ‡å›¾ï¼Œmousemove åªåšæœ¬åœ°ç»˜åˆ¶
        document.getElementById('drag-set-position').addEventListener('click', () => {
            fetch('/api/images').then(res => res.json()).then(data => {
                if (data.images.length === 0) { alert('è¯·å…ˆæ·»åŠ è‡³å°‘ä¸€ä¸ªå›¾ç‰‡'); return; }
                if (data.images.length === 1) { openDragPositionModal(0); return; }
                const selected = prompt(`è¯·è¾“å…¥è¦è°ƒæ•´çš„å›¾ç‰‡ç¼–å· (0-${data.images.length - 1}):\n\n` + data.images.map((img, i) => `${i}. ${img.name}`).join('\n'));
                if (selected !== null) { const index = parseInt(selected); if (!isNaN(index) && index >= 0 && index < data.images.length) openDragPositionModal(index); else alert('æ— æ•ˆçš„ç¼–å·'); }
            }).catch(err => console.error('è·å–å›¾ç‰‡åˆ—è¡¨å¤±è´¥:', err));
        });

        async function openDragPositionModal(index) {
            dragPositionIndex = index;
            try {
                // å¹¶è¡Œè·å–é¢„è§ˆä¸ç”»æ¿
                const [previewRes, boardRes] = await Promise.all([fetch(`/api/images/${index}/preview`), fetch('/api/board')]);
                const preview = await previewRes.json();
                const board = await boardRes.json();
                dragPositionImgX = preview.start_x; dragPositionImgY = preview.start_y; dragPositionImgWidth = preview.width; dragPositionImgHeight = preview.height;
                document.getElementById('drag-position-modal').style.display = 'block';

                // åˆ›å»º bitmap ç¼“å­˜
                try { if (dragBaseBitmap && dragBaseBitmap.close) dragBaseBitmap.close(); } catch (e) {}
                try { if (dragTargetBitmap && dragTargetBitmap.close) dragTargetBitmap.close(); } catch (e) {}
                const baseBlob = await (await fetch('data:image/png;base64,' + board.image)).blob();
                dragBaseBitmap = await createImageBitmap(baseBlob);
                const targetBlob = await (await fetch('data:image/png;base64,' + preview.image)).blob();
                dragTargetBitmap = await createImageBitmap(targetBlob);

                redrawDragPositionCached();
            } catch (err) { console.error('è·å–å›¾ç‰‡é¢„è§ˆæˆ–ç”»æ¿å¤±è´¥:', err); }
        }

        function redrawDragPositionCached() {
            const dragCanvas = document.getElementById('drag-position-canvas');
            const dragCtx = dragCanvas.getContext('2d');
            dragCtx.clearRect(0,0,dragCanvas.width,dragCanvas.height);
            if (dragBaseBitmap) dragCtx.drawImage(dragBaseBitmap, 0, 0);
            if (dragTargetBitmap) dragCtx.drawImage(dragTargetBitmap, dragPositionImgX, dragPositionImgY);
            dragCtx.strokeStyle = 'red'; dragCtx.lineWidth = 2;
            dragCtx.strokeRect(dragPositionImgX, dragPositionImgY, dragPositionImgWidth, dragPositionImgHeight);
            dragCtx.fillStyle = 'yellow'; dragCtx.font = '14px Arial'; dragCtx.fillText(`(${dragPositionImgX}, ${dragPositionImgY})`, dragPositionImgX + 5, dragPositionImgY + 20);
            document.getElementById('drag-position-coords').textContent = `(${dragPositionImgX}, ${dragPositionImgY})`;
        }

        const dragPosCanvas = document.getElementById('drag-position-canvas');
        dragPosCanvas.addEventListener('mousedown', e => {
            const rect = dragPosCanvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left; const mouseY = e.clientY - rect.top;
            if (mouseX >= dragPositionImgX && mouseX <= dragPositionImgX + dragPositionImgWidth && mouseY >= dragPositionImgY && mouseY <= dragPositionImgY + dragPositionImgHeight) {
                dragPositionDragging = true; dragPositionStartMouseX = mouseX; dragPositionStartMouseY = mouseY; dragPositionStartImgX = dragPositionImgX; dragPositionStartImgY = dragPositionImgY; dragPosCanvas.style.cursor = 'move';
            }
        });

        dragPosCanvas.addEventListener('mousemove', e => {
            if (!dragPositionDragging) return;
            const rect = dragPosCanvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left; const mouseY = e.clientY - rect.top;
            const dx = mouseX - dragPositionStartMouseX; const dy = mouseY - dragPositionStartMouseY;
            dragPositionImgX = Math.max(0, Math.min(1000 - dragPositionImgWidth, dragPositionStartImgX + dx));
            dragPositionImgY = Math.max(0, Math.min(600 - dragPositionImgHeight, dragPositionStartImgY + dy));
            redrawDragPositionCached();
        });

        dragPosCanvas.addEventListener('mouseup', () => { dragPositionDragging = false; dragPosCanvas.style.cursor = 'default'; });
        dragPosCanvas.addEventListener('mouseleave', () => { dragPositionDragging = false; dragPosCanvas.style.cursor = 'default'; });

        document.getElementById('apply-drag-position').addEventListener('click', () => {
            fetch(`/api/images/${dragPositionIndex}/position`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ start_x: dragPositionImgX, start_y: dragPositionImgY }) })
                .then(res => res.json()).then(() => { document.getElementById('drag-position-modal').style.display = 'none'; loadImages(); scheduleRedraw(); }).catch(err => console.error('åº”ç”¨ä½ç½®å¤±è´¥:', err));
        });

        document.getElementById('cancel-drag-position').addEventListener('click', () => { document.getElementById('drag-position-modal').style.display = 'none'; });
        document.getElementById('close-drag-position').addEventListener('click', () => { document.getElementById('drag-position-modal').style.display = 'none'; });

        // WebSocket å®æ—¶æ›´æ–°ï¼ˆç›®å‰ä¸ä¸»åŠ¨ä½¿ç”¨ï¼Œä½†ä¿ç•™ï¼‰
        socket.on('status_update', data => {});

        // åˆå§‹åŒ–å¹¶å¯åŠ¨å®šæ—¶ä»»åŠ¡
        initCanvas(); loadImages(); updateStatus(); loadUsers();
        setInterval(updateStatus, 1000);
        setInterval(scheduleRedraw, 4000); // æ¯4ç§’è°ƒåº¦ä¸€æ¬¡é‡ç»˜ï¼ˆå®é™…æœ‰ç¼“å­˜é¿å…é‡å¤è§£ç ï¼‰
        setInterval(loadImages, 5000);
        setInterval(loadUsers, 10000); // æ¯10ç§’åˆ·æ–°ç”¨æˆ·åˆ—è¡¨
    </script>
</body>
</html>
