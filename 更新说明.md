# LSP2025 Drawer 多图片支持更新说明

## 主要新功能

### 1. 多图片同时绘制
- ✅ 支持在 `config.json` 中配置多个图片
- ✅ 每个图片可独立设置：
  - 图片路径 (`image_path`)
  - 起始坐标 (`start_x`, `start_y`)
  - 绘图模式 (`draw_mode`: horizontal/concentric/random)
  - 权重 (`weight`): 重叠区域按权重优先级处理
  - 启用状态 (`enabled`): 可临时禁用某个图片

### 2. GUI 增强
- ✅ 图片管理界面：可视化管理所有图片
- ✅ 添加/编辑/删除图片功能
- ✅ 拖拽设置起点（在弹窗中直观调整）
- ✅ 实时预览所有图片的绘制效果
- ✅ 显示每个图片的边框（红色矩形）

### 3. 窗口优化（最新）
- ✅ 默认窗口大小：480×270 (1920×1080的1/4)
- ✅ 最小窗口：400×250
- ✅ 可滚动布局：支持小窗口显示所有元素
- ✅ 画板预览缩放：10%-100% 可调节
- ✅ 紧凑的UI布局：适应低分辨率屏幕
- ✅ 鼠标滚轮支持：方便浏览内容

## 配置文件格式

### 新格式（推荐）
```json
{
    "users": [
        {"uid": 123456, "access_key": "your_key"}
    ],
    "paint_interval_ms": 20,
    "round_interval_seconds": 3,
    "user_cooldown_seconds": 3,
    "log_level": "INFO",
    "images": [
        {
            "image_path": "image1.png",
            "start_x": 100,
            "start_y": 100,
            "draw_mode": "concentric",
            "weight": 2.0,
            "enabled": true
        },
        {
            "image_path": "image2.png",
            "start_x": 300,
            "start_y": 200,
            "draw_mode": "random",
            "weight": 1.0,
            "enabled": true
        }
    ]
}
```

### 旧格式（自动兼容）
```json
{
    "users": [...],
    "image_path": "image.png",
    "start_x": 0,
    "start_y": 0,
    "draw_mode": "random",
    ...
}
```
旧格式配置会自动转换为新格式，无需手动修改。

## 权重系统说明

当多个图片有重叠区域时：
- **权重越高的图片优先级越高**
- 例如：权重 2.0 的图片会覆盖权重 1.0 的图片
- 建议主要图片使用高权重，装饰图片使用低权重

## GUI 使用说明

### 画板预览
- 使用缩放滑块调整预览大小（10%-100%）
- 点击"👁️ 预览成果"切换目标图片覆盖层
- 红色边框显示每个图片的位置和范围

### 图片管理
1. **添加图片**：点击"➕ 添加"按钮选择图片文件
2. **编辑图片**：选中图片后点击"✏️ 编辑"修改参数
3. **删除图片**：选中后点击"🗑️ 删除"
4. **切换启用**：点击"⚡ 切换"快速启用/禁用图片

### 小窗口使用
- 窗口支持垂直滚动，使用鼠标滚轮浏览
- 所有元素都经过优化，在 480×270 窗口下正常显示
- 可以随时调整窗口大小，布局会自动适应

## 技术实现

### 核心改进
1. **tool.py**
   - 新增 `load_all_images()`: 加载所有图片配置
   - 新增 `merge_target_maps()`: 合并多图片目标映射，处理重叠
   - 保留 `load_image_pixels()` 以兼容旧代码

2. **main.py**
   - 修改 `load_config()`: 自动兼容新旧配置格式
   - 修改 `handle_websocket()`: 支持多图片数据结构
   - 移除单图片相关的全局变量

3. **gui.py**
   - 完全重构UI布局：使用可滚动Canvas
   - 添加图片列表表格（Treeview）
   - 实现图片管理功能（CRUD操作）
   - 添加缩放控制滑块
   - 优化按钮布局和图标

### 性能优化
- 画板底图每 30 秒重建一次（减少内存占用）
- 图片预览支持缩放（降低渲染负担）
- 多图片合并算法优化（O(n) 复杂度）

## 更新历史

### 2025-10-23
- ✅ 实现多图片同时绘制功能
- ✅ 重构GUI支持图片管理
- ✅ 优化窗口布局支持小屏幕
- ✅ 添加缩放功能和滚动支持
- ✅ 兼容旧配置文件格式

## 注意事项

1. **配置文件备份**：程序会自动保存配置，建议手动备份 `config.json`
2. **图片路径**：使用相对路径或绝对路径都可以
3. **性能建议**：建议同时绘制的图片数量不超过 10 个
4. **权重范围**：建议使用 0.1 到 10.0 之间的值
5. **窗口大小**：虽然支持小窗口，但建议使用 800×600 以上以获得最佳体验

## 常见问题

**Q: 旧配置文件还能用吗？**  
A: 可以！程序会自动转换为新格式，无需手动修改。

**Q: 如何在 GUI 中拖动图片设置起点？**  
A: 选中图片后点击"编辑"，在弹窗中修改起点坐标。未来版本会添加拖拽功能。

**Q: 两个图片重叠怎么办？**  
A: 通过设置不同的权重，高权重的图片会覆盖低权重的图片。

**Q: 窗口太小看不到所有按钮？**  
A: 使用鼠标滚轮向下滚动，或调整窗口大小。

**Q: 画板预览太小/太大？**  
A: 使用"缩放"滑块调整预览大小（10%-100%）。
